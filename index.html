<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APBDus 2026 - Kuamang Jaya</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; padding-bottom: 200px; }
        .card-header-custom { background-color: #198754; color: white; font-weight: bold; }
        .money { font-family: 'Courier New', monospace; font-weight: bold; }
        .accordion-button:not(.collapsed) { color: #0f5132; background-color: #d1e7dd; font-weight: bold; }
        .sub-bidang-title { font-size: 0.9rem; text-transform: uppercase; color: #198754; font-weight: 800; border-bottom: 2px solid #a3cfbb; padding: 5px 0 5px 10px; margin: 20px 0 10px 0; background-color: #e9f7ef; }
        .rincian-item { border-bottom: 1px dashed #e0e0e0; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .badge-sumber { font-size: 0.65rem; width: 45px; display: inline-block; text-align: center; margin-right: 8px; cursor: pointer; }
        
        /* Edit Mode Styles */
        .form-control-sm { border: 1px solid #198754; background-color: #f8fffb; color: #000; font-weight: bold; }
        .btn-edit { position: fixed; bottom: 20px; right: 20px; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .output-area { display: none; background: #2d2d2d; color: #76ff03; padding: 20px; border-radius: 10px; margin-top: 30px; font-family: monospace; }
        .editing-active .rincian-item { background-color: #fffde7; padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; }
    </style>
</head>
<body>

    <button onclick="toggleEditMode()" id="btnEdit" class="btn btn-warning btn-lg rounded-pill btn-edit">
        <i class="fas fa-pencil-alt me-2"></i>Edit Data
    </button>

    <div class="bg-white shadow-sm py-4 mb-4 border-bottom border-success border-4">
        <div class="container text-center">
            <h2 class="fw-bold text-success mb-0"><i class="fas fa-book-open me-2"></i>APBDus TA. 2026</h2>
            <p class="text-muted">Pemerintah Dusun Kuamang Jaya</p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row g-4 mb-4">
            <div class="col-md-4"><div class="card h-100 border-0 shadow-sm text-white bg-primary"><div class="card-body text-center"><h6 class="opacity-75">TOTAL PENDAPATAN</h6><h3 class="fw-bold" id="totalPendapatan">Rp 0</h3></div></div></div>
            <div class="col-md-4"><div class="card h-100 border-0 shadow-sm text-white bg-success"><div class="card-body text-center"><h6 class="opacity-75">TOTAL BELANJA</h6><h3 class="fw-bold" id="totalBelanja">Rp 0</h3></div></div></div>
            <div class="col-md-4"><div class="card h-100 border-0 shadow-sm text-dark bg-warning"><div class="card-body text-center"><h6 class="opacity-75">SURPLUS / (DEFISIT)</h6><h3 class="fw-bold" id="totalSelisih">Rp 0</h3></div></div></div>
        </div>

        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header card-header-custom">SUMBER PENDAPATAN</div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <tbody id="tabelPendapatan"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-danger text-white fw-bold d-flex justify-content-between">
                        <span><i class="fas fa-list-alt me-2"></i> RINCIAN BELANJA</span>
                        <small id="statusMode" class="text-white opacity-75 fst-italic">Mode Lihat</small>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="accordionBelanja"></div>
                        <div class="d-grid gap-2 mt-3">
                            <button onclick="tambahSubBidang()" id="btnAddSub" class="btn btn-outline-success d-none"><i class="fas fa-plus"></i> Tambah Kegiatan Baru (Dummy)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="outputPanel" class="output-area">
            <h4><i class="fas fa-code"></i> Kode Data Baru</h4>
            <p class="text-white small">Copy semua kode di bawah ini, lalu timpa bagian <code>&lt;script&gt;...&lt;/script&gt;</code> di file GitHub Anda.</p>
            <textarea id="codeResult" class="form-control bg-dark text-white border-secondary" rows="10" style="font-family: monospace; font-size: 0.8rem;"></textarea>
            <button onclick="copyCode()" class="btn btn-light btn-sm mt-2">Copy Kode</button>
        </div>

        <div class="text-center mt-5 text-muted small pb-4"><p>&copy; 2026 Pemerintah Dusun Kuamang Jaya.</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script id="dataScript">
        // --- DATA AWAL (DATABASE SEMENTARA) ---
        let dataPendapatan = [
            { uraian: "Dana Desa (DDS)",     kode: "DDS", nominal: 900000000 },
            { uraian: "Alokasi Dana Dusun",  kode: "ADD", nominal: 500000000 },
            { uraian: "Bagi Hasil Pajak",    kode: "PBH", nominal: 50000000 },
            { uraian: "Pendapatan Asli",     kode: "PAD", nominal: 350000000 },
            { uraian: "Bantuan Provinsi",    kode: "PBP", nominal: 50000000 },
        ];

        let dataBelanja = [
            {
                bidang: "1. Bidang Penyelenggaraan Pemerintahan",
                subBidang: [
                    {
                        namaSub: "1.1. Siltap & Tunjangan",
                        kegiatan: [
                            { nama: "Siltap Rio & Perangkat",  sumber: "ADD", nilai: 320000000 },
                            { nama: "Tunjangan BPD",           sumber: "ADD", nilai: 40000000 },
                        ]
                    },
                    {
                        namaSub: "1.2. Operasional Pemerintahan",
                        kegiatan: [
                            { nama: "ATK, Listrik, Internet",  sumber: "PBH", nilai: 50000000 },
                            { nama: "Operasional RT/RW",       sumber: "ADD", nilai: 80000000 },
                        ]
                    }
                ]
            },
            {
                bidang: "2. Bidang Pembangunan",
                subBidang: [
                    {
                        namaSub: "2.3. Pekerjaan Umum",
                        kegiatan: [
                            { nama: "Jalan Usaha Tani",      sumber: "DDS", nilai: 300000000 },
                        ]
                    }
                ]
            }
        ];

        // --- SYSTEM ---
        let isEditing = false;
        const fmt = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n);

        function render() {
            // 1. Render Pendapatan
            let htmlPend = "";
            let totPend = 0;
            dataPendapatan.forEach((d, i) => {
                totPend += parseInt(d.nominal);
                if (isEditing) {
                    htmlPend += `<tr>
                        <td class="p-1"><input type="text" class="form-control form-control-sm" value="${d.uraian}" onchange="updatePendapatan(${i}, 'uraian', this.value)"></td>
                        <td class="p-1"><input type="number" class="form-control form-control-sm text-end" value="${d.nominal}" onchange="updatePendapatan(${i}, 'nominal', this.value)"></td>
                    </tr>`;
                } else {
                    let wb = d.kode === 'DDS' ? 'bg-primary' : d.kode === 'ADD' ? 'bg-success' : d.kode === 'PAD' ? 'bg-warning text-dark' : 'bg-secondary';
                    htmlPend += `<tr><td class="ps-3 small">${d.uraian} <span class="badge ${wb} ms-1" style="font-size:0.6rem">${d.kode}</span></td><td class="money pe-3 text-end small">${fmt(d.nominal)}</td></tr>`;
                }
            });
            htmlPend += `<tr class="table-secondary fw-bold"><td class="ps-3">TOTAL</td><td class="money pe-3 text-end">${fmt(totPend)}</td></tr>`;
            document.getElementById('tabelPendapatan').innerHTML = htmlPend;
            document.getElementById('totalPendapatan').innerText = fmt(totPend);

            // 2. Render Belanja
            let htmlBel = "";
            let totBel = 0;
            dataBelanja.forEach((bid, idxBid) => {
                let totalBidang = 0;
                let subHtml = "";
                
                bid.subBidang.forEach((sub, idxSub) => {
                    if(isEditing) {
                        subHtml += `<div class="mt-3"><input type="text" class="form-control form-control-sm fw-bold text-success mb-2" value="${sub.namaSub}" onchange="updateNamaSub(${idxBid}, ${idxSub}, this.value)"></div>`;
                    } else {
                        subHtml += `<div class="sub-bidang-title">${sub.namaSub}</div>`;
                    }

                    sub.kegiatan.forEach((keg, idxKeg) => {
                        totalBidang += parseInt(keg.nilai);
                        totBel += parseInt(keg.nilai);
                        
                        if(isEditing) {
                            subHtml += `
                            <div class="rincian-item">
                                <div class="row g-1 w-100">
                                    <div class="col-6"><input type="text" class="form-control form-control-sm" value="${keg.nama}" onchange="updateKegiatan(${idxBid}, ${idxSub}, ${idxKeg}, 'nama', this.value)"></div>
                                    <div class="col-2"><select class="form-select form-select-sm" onchange="updateKegiatan(${idxBid}, ${idxSub}, ${idxKeg}, 'sumber', this.value)">
                                        <option value="DDS" ${keg.sumber=='DDS'?'selected':''}>DDS</option>
                                        <option value="ADD" ${keg.sumber=='ADD'?'selected':''}>ADD</option>
                                        <option value="PBH" ${keg.sumber=='PBH'?'selected':''}>PBH</option>
                                        <option value="PAD" ${keg.sumber=='PAD'?'selected':''}>PAD</option>
                                        <option value="PBP" ${keg.sumber=='PBP'?'selected':''}>PBP</option>
                                    </select></div>
                                    <div class="col-4"><input type="number" class="form-control form-control-sm text-end" value="${keg.nilai}" onchange="updateKegiatan(${idxBid}, ${idxSub}, ${idxKeg}, 'nilai', this.value)"></div>
                                </div>
                            </div>`;
                        } else {
                            let wb = keg.sumber === 'DDS' ? 'bg-primary' : keg.sumber === 'ADD' ? 'bg-success' : keg.sumber === 'PBH' ? 'bg-info text-dark' : keg.sumber === 'PAD' ? 'bg-warning text-dark' : 'bg-secondary';
                            subHtml += `<div class="rincian-item ps-3"><span class="item-detail">${keg.nama}</span><div><span class="badge ${wb} badge-sumber">${keg.sumber}</span><b class="money">${fmt(keg.nilai)}</b></div></div>`;
                        }
                    });
                });

                htmlBel += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="h${idxBid}">
                        <button class="accordion-button ${idxBid !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#c${idxBid}">
                            ${bid.bidang}
                            <span class="ms-auto badge bg-secondary">${fmt(totalBidang)}</span>
                        </button>
                    </h2>
                    <div id="c${idxBid}" class="accordion-collapse collapse ${idxBid === 0 ? 'show' : ''}" data-bs-parent="#accordionBelanja">
                        <div class="accordion-body bg-light pt-0">${subHtml}</div>
                    </div>
                </div>`;
            });
            
            document.getElementById('accordionBelanja').innerHTML = htmlBel;
            document.getElementById('totalBelanja').innerText = fmt(totBel);
            document.getElementById('totalSelisih').innerText = fmt(totPend - totBel);

            // Tampilkan Panel Code jika sedang edit
            if(isEditing) {
                generateCode();
                document.getElementById('outputPanel').style.display = 'block';
                document.getElementById('btnAddSub').classList.remove('d-none');
                document.getElementById('statusMode').innerText = "Mode Edit Aktif";
                document.body.classList.add('editing-active');
            } else {
                document.getElementById('outputPanel').style.display = 'none';
                document.getElementById('btnAddSub').classList.add('d-none');
                document.getElementById('statusMode').innerText = "Mode Lihat";
                document.body.classList.remove('editing-active');
            }
        }

        // --- UPDATE FUNCTIONS ---
        function updatePendapatan(idx, field, val) {
            if(field === 'nominal') val = parseInt(val);
            dataPendapatan[idx][field] = val;
            render();
        }
        function updateNamaSub(idxBid, idxSub, val) {
            dataBelanja[idxBid].subBidang[idxSub].namaSub = val;
            render(); // Tidak perlu re-generate code di sini agar tidak berat, generate saat render
        }
        function updateKegiatan(idxBid, idxSub, idxKeg, field, val) {
            if(field === 'nilai') val = parseInt(val);
            dataBelanja[idxBid].subBidang[idxSub].kegiatan[idxKeg][field] = val;
            render();
        }
        function tambahSubBidang() {
            // Menambah data dummy ke Bidang 2 (Pembangunan) sebagai contoh
            dataBelanja[1].subBidang[0].kegiatan.push({ nama: "Kegiatan Baru", sumber: "DDS", nilai: 0 });
            render();
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            const btn = document.getElementById('btnEdit');
            if(isEditing) {
                btn.innerHTML = '<i class="fas fa-save me-2"></i>Selesai Edit';
                btn.classList.replace('btn-warning', 'btn-success');
            } else {
                btn.innerHTML = '<i class="fas fa-pencil-alt me-2"></i>Edit Data';
                btn.classList.replace('btn-success', 'btn-warning');
            }
            render();
        }

        function generateCode() {
            // Fungsi untuk menghasilkan string JSON dari data saat ini
            let scriptContent = `
        // --- DATA AWAL (DATABASE SEMENTARA) ---
        let dataPendapatan = ${JSON.stringify(dataPendapatan, null, 4)};

        let dataBelanja = ${JSON.stringify(dataBelanja, null, 4)};
            `;
            document.getElementById('codeResult').value = scriptContent;
        }

        function copyCode() {
            const copyText = document.getElementById("codeResult");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            alert("Kode berhasil disalin! Silakan paste ke file index.html di GitHub pada bagian script.");
        }

        // Initial Render
        render();
    </script>
</body>
</html>
